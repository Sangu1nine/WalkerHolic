# WebSocket â†” Supabase ì—°ë™ ì ê²€ ê²°ê³¼

## ğŸ“‹ ì ê²€ ê°œìš”

ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ WebSocketì„ í†µí•´ ì „ì†¡ë˜ëŠ” ë°ì´í„°ê°€ Supabase `fall_data` í…Œì´ë¸”ì— ì œëŒ€ë¡œ ì €ì¥ë˜ëŠ”ì§€ ì ê²€í•œ ê²°ê³¼ì…ë‹ˆë‹¤.

## ğŸ” ë°œê²¬ëœ ë¬¸ì œì ê³¼ í•´ê²°ì±…

### âŒ ê¸°ì¡´ ë¬¸ì œì 
1. **WebSocketManagerì—ì„œ Supabase ì €ì¥ ë¡œì§ ëˆ„ë½**
   - ê¸°ì¡´ì—ëŠ” CSV íŒŒì¼ë¡œë§Œ ë°±ì—…í•˜ê³  ìˆì—ˆìŒ
   - Supabase ì—°ê²° ì½”ë“œê°€ ì—†ì—ˆìŒ

2. **SupabaseClientì— fall_data ì €ì¥ ë©”ì„œë“œ ëˆ„ë½**
   - `save_imu_data` ë©”ì„œë“œëŠ” ìˆì—ˆì§€ë§Œ `save_fall_data` ë©”ì„œë“œê°€ ì—†ì—ˆìŒ

### âœ… ì ìš©ëœ í•´ê²°ì±…

#### 1. WebSocketManager ìˆ˜ì •
- `database.supabase_client` import ì¶”ê°€
- `handle_imu_data` ë©”ì„œë“œì— Supabase ì €ì¥ ë¡œì§ ì¶”ê°€
- `handle_event` ë©”ì„œë“œì— ë‚™ìƒ ì´ë²¤íŠ¸ Supabase ì €ì¥ ë¡œì§ ì¶”ê°€

#### 2. SupabaseClient í™•ì¥
- `save_fall_data` ë©”ì„œë“œ ì¶”ê°€
- fall_data í…Œì´ë¸”ì— ë°ì´í„° ì €ì¥ ê¸°ëŠ¥ êµ¬í˜„

## ğŸ“Š ë°ì´í„° íë¦„

```
ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„¼ì„œ ë°ì´í„°
        â†“
   WebSocket ì „ì†¡
        â†“
 WebSocketManager.process_data()
        â†“
handle_imu_data() / handle_event()
        â†“
    Supabase fall_data í…Œì´ë¸” ì €ì¥
        â†“
    CSV ë°±ì—… (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
```

## ğŸ—ƒï¸ ë°ì´í„° í˜•ì‹

### ì„¼ì„œ ë°ì´í„° (ë¼ì¦ˆë² ë¦¬íŒŒì´ â†’ Supabase)

**ë¼ì¦ˆë² ë¦¬íŒŒì´ ì „ì†¡ í˜•ì‹:**
```json
{
    "timestamp": 1234567890.123,
    "accel": {"x": 1.23, "y": 2.34, "z": 9.81},
    "gyro": {"x": 0.12, "y": 0.23, "z": 0.34}
}
```

**Supabase fall_data ì €ì¥ í˜•ì‹:**
```json
{
    "user_id": "raspberry_pi_01",
    "timestamp": "2024-01-15T10:30:45.123",
    "acc_x": 1.23,
    "acc_y": 2.34,
    "acc_z": 9.81,
    "gyr_x": 0.12,
    "gyr_y": 0.23,
    "gyr_z": 0.34,
    "event_type": "sensor_data"
}
```

### ë‚™ìƒ ì´ë²¤íŠ¸ (ë¼ì¦ˆë² ë¦¬íŒŒì´ â†’ Supabase)

**ë¼ì¦ˆë² ë¦¬íŒŒì´ ì „ì†¡ í˜•ì‹:**
```json
{
    "event": "fall_detected",
    "timestamp": 1234567890.123,
    "probability": 0.85
}
```

**Supabase fall_data ì €ì¥ í˜•ì‹:**
```json
{
    "user_id": "raspberry_pi_01",
    "timestamp": "2024-01-15T10:30:45.123",
    "event_type": "fall_detected",
    "acc_x": 0.85,  // ë‚™ìƒ í™•ë¥ ì„ ì„ì‹œë¡œ ì €ì¥
    "acc_y": 0,
    "acc_z": 0,
    "gyr_x": 0,
    "gyr_y": 0,
    "gyr_z": 0
}
```

## ğŸ”§ í•˜ì´ë¸Œë¦¬ë“œ ì €ì¥ ì‹œìŠ¤í…œ

### ì£¼ ì €ì¥ì†Œ: Supabase
- ì‹¤ì‹œê°„ ë°ì´í„° ì ‘ê·¼
- ì›¹ ëŒ€ì‹œë³´ë“œ ì—°ë™
- í´ë¼ìš°ë“œ ë°±ì—…

### ë³´ì¡° ì €ì¥ì†Œ: CSV íŒŒì¼
- ë¡œì»¬ ë°±ì—…
- ì˜¤í”„ë¼ì¸ ë¶„ì„ ì§€ì›
- ë„¤íŠ¸ì›Œí¬ ì¥ì•  ëŒ€ë¹„

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
cd backend/tools
python test_websocket_supabase.py
```

### 2. ë¼ì¦ˆë² ë¦¬íŒŒì´ ì‹œë®¬ë ˆì´ì…˜
```bash
cd backend/tools
python raspberry_websocket_modified.py
```

### 3. ìˆ˜ë™ í…ŒìŠ¤íŠ¸
WebSocket í´ë¼ì´ì–¸íŠ¸ë¡œ ë‹¤ìŒ ë°ì´í„° ì „ì†¡:
```javascript
// ì„¼ì„œ ë°ì´í„°
ws.send(JSON.stringify({
    timestamp: Date.now() / 1000,
    accel: {x: 1.0, y: 2.0, z: 9.8},
    gyro: {x: 0.1, y: 0.2, z: 0.3}
}));

// ë‚™ìƒ ì´ë²¤íŠ¸
ws.send(JSON.stringify({
    event: 'fall_detected',
    timestamp: Date.now() / 1000,
    probability: 0.85
}));
```

## âœ… í™•ì¸ ì‚¬í•­

### ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸
- Supabase ì €ì¥ ì„±ê³µ ë©”ì‹œì§€
- ë°ì´í„° í˜•ì‹ ë³€í™˜ ë¡œê·¸
- ì˜¤ë¥˜ ë°œìƒ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€

### Supabase ëŒ€ì‹œë³´ë“œ í™•ì¸
1. Supabase í”„ë¡œì íŠ¸ ì ‘ì†
2. Table Editor â†’ fall_data í…Œì´ë¸” í™•ì¸
3. ì‹¤ì‹œê°„ ë°ì´í„° ì…ë ¥ ì—¬ë¶€ í™•ì¸

### ë¡œì»¬ ë°±ì—… í™•ì¸
- `backend/data_backup/` í´ë”ì˜ CSV íŒŒì¼
- `events.csv` íŒŒì¼ì˜ ì´ë²¤íŠ¸ ë¡œê·¸

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. ë„¤íŠ¸ì›Œí¬ ì¥ì•  ëŒ€ì‘
- Supabase ì—°ê²° ì‹¤íŒ¨ ì‹œ CSV ë°±ì—…ì€ ê³„ì† ë™ì‘
- ì—ëŸ¬ ë¡œê¹…ìœ¼ë¡œ ë¬¸ì œ ìƒí™© ì¶”ì 

### 2. ë°ì´í„° í˜•ì‹ í˜¸í™˜ì„±
- ë‹¤ì–‘í•œ í´ë¼ì´ì–¸íŠ¸ í˜•ì‹ ì§€ì›
- íƒ€ì„ìŠ¤íƒ¬í”„ ìë™ ìƒì„± (ëˆ„ë½ ì‹œ)

### 3. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­
- 100Hz ì„¼ì„œ ë°ì´í„°ì˜ ì‹¤ì‹œê°„ ì €ì¥
- ë²„í¼ë§ì„ í†µí•œ ë¶€í•˜ ë¶„ì‚°
- ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì§€ì—° ìµœì†Œí™”

## ğŸ”„ í–¥í›„ ê°œì„  ì‚¬í•­

### 1. í…Œì´ë¸” êµ¬ì¡° ìµœì í™”
- `fall_probability` ì»¬ëŸ¼ ì¶”ê°€ (í˜„ì¬ëŠ” acc_xì— ì„ì‹œ ì €ì¥)
- `metadata` JSON ì»¬ëŸ¼ ì¶”ê°€ (í™•ì¥ì„±)

### 2. ë°°ì¹˜ ì²˜ë¦¬ ë„ì…
- ì—¬ëŸ¬ ë°ì´í„°ë¥¼ ë¬¶ì–´ì„œ ì¼ê´„ ì €ì¥
- ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„± í–¥ìƒ

### 3. ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ
- ë‚™ìƒ ê°ì§€ ì‹œ ì¦‰ì‹œ ì•Œë¦¼
- Supabase Realtime í™œìš©

## ğŸ“ˆ ëª¨ë‹ˆí„°ë§

### ì„±ëŠ¥ ì§€í‘œ
- ë°ì´í„° ì €ì¥ ì„±ê³µë¥ 
- ì‘ë‹µ ì‹œê°„
- ì—ëŸ¬ ë°œìƒ ë¹ˆë„

### ì•Œë¦¼ ì„¤ì •
- Supabase ì—°ê²° ì‹¤íŒ¨
- ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì§€ì—°
- ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± (CSV ë°±ì—…)

---

**ê²°ë¡ **: ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ WebSocketìœ¼ë¡œ ì „ì†¡ë˜ëŠ” ë°ì´í„°ê°€ Supabase fall_data í…Œì´ë¸”ì— ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ë„ë¡ ì‹œìŠ¤í…œì´ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ì´ë¸Œë¦¬ë“œ ì €ì¥ ë°©ì‹ì„ í†µí•´ ì•ˆì •ì„±ê³¼ ì ‘ê·¼ì„±ì„ ëª¨ë‘ í™•ë³´í–ˆìŠµë‹ˆë‹¤. 